<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#0c1117">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Checklist Solar - ATALAYA</title>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<script src="master.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--bg:#0c1117;--sf:#161d27;--sf2:#1e2736;--bd:#2a3545;--ac:#f59e0b;--ok:#22c55e;--no:#ef4444;--na:#6b7280;--tx:#e8eaed;--td:#7a8a9a}
body{background:var(--bg);color:var(--tx);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;overscroll-behavior:none;user-select:none;-webkit-user-select:none}
input,textarea,select{user-select:text;-webkit-user-select:text;font-size:16px!important}
button{cursor:pointer;border:none;outline:none;font-family:inherit}
input,textarea,select{border:none;outline:none;font-family:inherit}
.hide{display:none!important}
.hdr{position:sticky;top:0;z-index:50;padding:12px 16px;display:flex;align-items:center;gap:12px;background:var(--bg);border-bottom:1px solid var(--bd)}
.hdr h1{font-size:17px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hdr .sub{font-size:11px;color:var(--td)}
.hdr-r{margin-left:auto;display:flex;gap:6px;align-items:center;flex-shrink:0}
.btn-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;background:var(--sf2)}
.card{background:var(--sf);border-radius:12px;padding:12px;margin-bottom:8px}
.card-row{display:flex;align-items:center;gap:12px}
.card-label{flex:1;font-size:13px;line-height:1.3}
.stitle{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--ac);padding:4px 4px 8px}
.inp{width:100%;height:46px;border-radius:10px;padding:0 14px;font-size:16px;font-family:monospace;background:var(--sf2);color:var(--tx);border:2px solid var(--bd)}
.inp:focus,.inp.has{border-color:var(--ac)}
.inp.bad{border-color:var(--no)!important;background:#1a0a0a;color:var(--no)}
.sel{height:46px;border-radius:10px;padding:0 12px;font-size:15px;background:var(--sf2);color:var(--tx);border:2px solid var(--bd);appearance:none;-webkit-appearance:none}
.okno{display:flex;gap:4px}
.okno.cmp{width:150px;flex-shrink:0}
.okno button{flex:1;height:42px;border-radius:10px;font-weight:700;font-size:12px;border:2px solid var(--bd);background:var(--sf);color:var(--td);transition:all .15s}
.okno.cmp button{height:34px;font-size:11px}
.okno button.s-ok{background:var(--ok);border-color:var(--ok);color:#fff}
.okno button.s-no{background:var(--no);border-color:var(--no);color:#fff}
.okno button.s-na{background:var(--na);border-color:var(--na);color:#fff}
.tabs{display:flex;overflow-x:auto;gap:4px;padding-bottom:8px;-webkit-overflow-scrolling:touch}
.tabs::-webkit-scrollbar{display:none}
.tab{flex-shrink:0;padding:8px 14px;border-radius:10px;font-size:12px;font-weight:600;white-space:nowrap;background:var(--sf2);color:var(--td)}
.tab.on{background:var(--ac);color:var(--bg)}
.pils{display:flex;overflow-x:auto;gap:6px;padding:10px 0;-webkit-overflow-scrolling:touch}
.pils::-webkit-scrollbar{display:none}
.pil{flex-shrink:0;min-width:52px;padding:6px 8px;border-radius:8px;font-size:11px;font-weight:700;text-align:center;border:2px solid var(--bd);background:transparent;color:var(--td)}
.pil.on{background:var(--sf2);border-color:var(--ac);color:var(--ac)}
.pil.ok{border-color:var(--ok);color:var(--ok)}
.prog{width:100%;height:7px;border-radius:4px;background:var(--bd);overflow:hidden}
.prog-b{height:100%;border-radius:4px;transition:width .5s;background:var(--ac)}
.prog-b.done{background:var(--ok)}
.photo-row{display:flex;gap:6px;overflow-x:auto;padding-bottom:8px;-webkit-overflow-scrolling:touch}
.ph-th{position:relative;flex-shrink:0;width:64px;height:64px;border-radius:10px;overflow:hidden;border:2px solid var(--bd)}
.ph-th img{width:100%;height:100%;object-fit:cover}
.ph-del{position:absolute;top:2px;right:2px;width:18px;height:18px;border-radius:50%;background:var(--no);color:#fff;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center}
.ph-add{flex-shrink:0;width:64px;height:64px;border-radius:10px;border:2px dashed var(--bd);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;color:var(--td);font-size:10px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.sc{padding:14px;border-radius:12px;background:var(--sf)}
.sc-l{font-size:11px;color:var(--td)}.sc-v{font-size:22px;font-weight:700;margin-top:2px}
.gps-i{display:flex;gap:8px;align-items:center;padding:6px 10px;border-radius:8px;background:var(--sf2);font-size:11px;color:var(--td);margin-bottom:6px}
.gps-d{width:8px;height:8px;border-radius:50%;background:var(--ok);animation:pu 2s infinite;display:inline-block}
@keyframes pu{0%,100%{opacity:1}50%{opacity:.3}}
.exp{margin:8px 16px;padding:14px;border-radius:12px;background:var(--sf);border:1px solid var(--ac)}
.exp-b{width:100%;height:46px;border-radius:12px;font-weight:700;font-size:13px;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:6px}
.cnt{padding:0 16px 32px}
.ta{width:100%;border-radius:10px;padding:10px;font-size:14px;background:var(--sf2);color:var(--tx);border:2px solid var(--bd);resize:none}
.sum-row{display:flex;align-items:center;gap:8px;margin-top:6px;padding:6px 8px;border-radius:8px;background:var(--sf2);font-size:12px}
.sync-dot{display:inline-flex;align-items:center;gap:3px;font-size:11px;padding:4px 8px;border-radius:6px;background:var(--sf2)}
</style>
</head>
<body>
<div id="app"></div>
<input type="file" id="cam" accept="image/*" capture="environment" multiple style="display:none">

<script>
const SK='checklist-solar-v3',CK='checklist-solar-cfg';
let APP=ld(SK)||{trackers:{}}, CFG=ld(CK)||{syncUrl:'',tecnico:''};
const SYNC_URL='https://script.google.com/macros/s/AKfycbxNbWR8rqrsugUEfJClSfTCtJVI9Gze5j9l6330Iw81v_fuTApAaAZkwt3GEjqHIBQ6/exec';
CFG.syncUrl=SYNC_URL;
let V={screen:CFG.tecnico?'home':'setup',tr:null,tab:'cim',pi:0,fila:'motor',exp:false,ms:null};
let GPS=null, SYNC_OK=null, SYNC_Q=[], SYNC_T=null;

function ld(k){try{return JSON.parse(localStorage.getItem(k))}catch{return null}}
function sv(){try{localStorage.setItem(SK,JSON.stringify(APP))}catch(e){}}
function sc(){try{localStorage.setItem(CK,JSON.stringify(CFG))}catch(e){}}

// PILLAR CONFIG
const PCFG={
  monofila_corto:{motor:['2N-MP','1N-MP','MP','1S-MP','2S-MP'],conducida:null},
  monofila_largo:{motor:['4N-MP','3N-MP','2N-MP','1N-MP','MP','1S-MP','2S-MP','3S-MP','4S-MP'],conducida:null},
  bifila_corto:{motor:['2N-MP','1N-MP','MP','1S-MP','2S-MP'],conducida:['2N','1N','MP-FC','1S','2S']},
  bifila_largo:{motor:['4N-MP','3N-MP','2N-MP','1N-MP','MP','1S-MP','2S-MP','3S-MP','4S-MP'],conducida:['4N','3N','2N','1N','MP-FC','1S','2S','3S','4S']}
};

// DISTANCE AUTO-SUM CONFIG
// Largo: pilars 0-8 (4N,3N,2N,1N,MP,1S,2S,3S,4S), MP=index 4
const DIST_LARGO={
  3:{seg:7610,tol:[7570,7630]},   // 1N
  2:{seg:7210,tol:[14770,14830]}, // 2N = 7210 + dist_1N
  1:{seg:7010,tol:[21770,21830]}, // 3N
  0:{seg:6710,tol:[28470,28530]}, // 4N
  5:{seg:7630,tol:[7570,7630]},   // 1S
  6:{seg:7210,tol:[14770,14830]}, // 2S
  7:{seg:7000,tol:[21770,21830]}, // 3S
  8:{seg:6710,tol:[28470,28530]}, // 4S
};
// Corto: pilars 0-4 (2N,1N,MP,1S,2S), MP=index 2
const DIST_CORTO={
  1:{seg:6710,tol:[6670,6730]},    // 1N
  0:{seg:6715,tol:[13370,13430]},  // 2N
  3:{seg:6695,tol:[6670,6730]},    // 1S
  4:{seg:6705,tol:[13370,13430]},  // 2S
};

function getDistCfg(type){return(type==='bifila_largo'||type==='monofila_largo')?DIST_LARGO:DIST_CORTO}
function getMPi(type){return(type==='bifila_largo'||type==='monofila_largo')?4:2}

function calcDistSum(td,px,pi,type){
  const dc=getDistCfg(type),mpI=getMPi(type);
  if(pi===mpI||!dc[pi])return null;
  let sum=0;
  if(pi<mpI){for(let i=pi;i<mpI;i++){const t=td.cim[`${px}_${i}_dist_ns_tramo`];if(t==null)return null;sum+=t}}
  else{for(let i=pi;i>mpI;i--){const t=td.cim[`${px}_${i}_dist_ns_tramo`];if(t==null)return null;sum+=t}}
  return sum;
}

// FIELD DEFINITIONS
const MED=[
  {id:'altura',label:'Altura pilar (Distancia libre)',type:'number',unit:'mm'},
  {id:'vert_ns',label:'Verticalidad N-S',type:'number',unit:'¬∫',tol:[88,102]},
  {id:'vert_eo',label:'Verticalidad E-O',type:'number',unit:'¬∫',tol:[88,102]},
  {id:'torsion',label:'Torsi√≥n en cabeza de pilares',type:'okno',def:'NO'},
  {id:'desv_eo',label:'Desviaci√≥n Este-Oeste cabezas',type:'okno',def:'NO'},
  {id:'desv_altura',label:'Desviaci√≥n de Altura (Dv)',type:'okno',def:'NO'},
  {id:'dist_ns_tramo',label:'Distancia N-S al pilar anterior (tramo)',type:'number',unit:'mm',isTramo:true},
];
const COMP=[
  {id:'galvanizado',label:'Reparaci√≥n galvanizado seg√∫n procedimiento',def:'SI'},
  {id:'golpes',label:'Deformaci√≥n por golpes',def:'NO'},
  {id:'entalladura',label:'Deformaci√≥n por entalladura',def:'NO'},
  {id:'pliegue',label:'Deformaci√≥n por pliegue',def:'NO'},
  {id:'cabezas',label:'Deformaciones en cabezas del pilar',def:'NO'},
  {id:'corte',label:'Corte y mecanizado',def:'NO'},
  {id:'mecanizados',label:'Mecanizados fuera de tolerancias',def:'NO'},
  {id:'orientacion',label:'Orientaci√≥n correcta pilares (Norte-Sur)',def:'SI'},
  {id:'perfil',label:'Perfil de secci√≥n correcta',def:'SI'},
  {id:'relleno',label:'Relleno de perforaciones',def:'N/A'},
  {id:'oxidacion',label:'Presencia de oxidaci√≥n',def:'NO'},
  {id:'socavones',label:'Socavones en pie de pilar',def:'NO'},
  {id:'cimentacion',label:'Validaci√≥n de cimentaci√≥n',def:'SI'},
  {id:'zanjas',label:'Zanjas y excavaciones < 1500 mm',def:'NO'},
  {id:'centrado',label:'Pilar centrado Micropilote',def:'N/A'},
  {id:'diametro',label:'Di√°metro correcto Micropilote',def:'N/A'}
];
const MONT=[
  {id:'ms',title:'Soporte central (MS)',items:[{id:'ms_par',label:'Par apriete torniller√≠a (230 N.m)'},{id:'ms_sup',label:'Superficie soportes paralela pendiente N-S'},{id:'ms_ali',label:'Ambos soportes alineados mismo plano'},{id:'ms_gir',label:'Par apriete torniller√≠a giro'}]},
  {id:'bs',title:'Cabeza de giro (BS)',items:[{id:'bs_par',label:'Par apriete torniller√≠a (280 N.m)'},{id:'bs_peg',label:'Pegatina actuador = referencia B1'},{id:'bs_mot',label:'Motor DC orientado al Oeste'}]},
  {id:'b1',title:'Viga Central (B1)',items:[{id:'b1_par',label:'Par apriete torniller√≠a (280 N.m)'},{id:'b1_sol',label:'Soldadura vigas orientada al suelo'}]},
  {id:'sf',title:'Vigas Secundarias (SF)',items:[{id:'sf_par',label:'Par apriete torniller√≠a (140 N.m)'},{id:'sf_rem',label:'Correcto remachado entre vigas'},{id:'sf_pin',label:'Correcto pintado de remaches'},{id:'sf_vis',label:'Visores en caras verticales'}]},
  {id:'ds',title:'Dampers (DS)',items:[{id:'ds_par',label:'Par apriete torniller√≠a (20 N.m)'},{id:'ds_est',label:'Dampers al ESTE en mitad ESTE'},{id:'ds_oes',label:'Dampers al OESTE en mitad OESTE'},{id:'ds_pc',label:'Ubicaci√≥n damper pilar C'},{id:'ds_pw',label:'Ubicaci√≥n damper pilar W'},{id:'ds_cil',label:'Cilindro damper hacia abajo'}]},
  {id:'vp',title:'Vigas Principales',items:[{id:'vp_140',label:'Par apriete (140 N.m)'},{id:'vp_410',label:'Par apriete (410 N.m)'},{id:'vp_sim',label:'Simetr√≠a E-O (¬±15mm)'},{id:'vp_per',label:'Perpendicularidad'},{id:'vp_ali',label:'Alineaci√≥n'}]},
  {id:'tr',title:'Transmisi√≥n (TR)',items:[{id:'tr_par',label:'Par apriete torniller√≠a (140 N.m)'},{id:'tr_ang',label:'√Ångulo slews motor/conducido (¬±0.20¬∫)'},{id:'tr_car',label:'Montaje tornillo card√°n'},{id:'tr_esp',label:'Espaciado card√°n-viga (80-120mm)'},{id:'tr_cpa',label:'Par tornillo card√°n (30 N.m)'},{id:'tr_u9',label:'Marcado Uni√≥n 9 (10 N.m)'},{id:'tr_u4',label:'Par Uni√≥n 4 (35 N.m)'},{id:'tr_u13',label:'Par Uni√≥n 13 (140 N.m)'},{id:'tr_u8',label:'Marcado Uni√≥n 8 (20 N.m)'},{id:'tr_u32',label:'Par Uni√≥n 32 (140 N.m)'}]},
  {id:'pat',title:'Puesta a Tierra',items:[{id:'pat_ok',label:'Correcta instalaci√≥n PAT'},{id:'pat_int',label:'PAT sin interferencias'}]},
  {id:'tp',title:'Tap√≥n Pl√°stico',items:[{id:'tp_ok',label:'Tapones con tornillos autorroscantes'}]},
  {id:'iv',title:'Inspecciones Visuales',items:[{id:'iv_gol',label:'Sin golpes/deformaciones'},{id:'iv_mod',label:'Sin modificaciones estructurales'},{id:'iv_gal',label:'Galvanizado reparado'},{id:'iv_tor',label:'Torniller√≠a en buenas condiciones'}]}
];

// GPS
function startGPS(){
  if(!navigator.geolocation)return;
  navigator.geolocation.watchPosition(p=>{
    GPS={lat:p.coords.latitude,lon:p.coords.longitude,acc:p.coords.accuracy,ts:Date.now()};
    document.querySelectorAll('.gps-live').forEach(el=>{
      el.innerHTML='<span class="gps-d"></span> GPS: '+GPS.lat.toFixed(6)+', '+GPS.lon.toFixed(6)+' ¬∑ ¬±'+Math.round(GPS.acc)+'m';
    });
  },()=>{},{enableHighAccuracy:true,maximumAge:10000});
}
function gpsNow(){return GPS?{lat:GPS.lat,lon:GPS.lon,acc:Math.round(GPS.acc),ts:new Date().toISOString()}:{ts:new Date().toISOString()}}

// ============================================================
// SYNC ‚Äî Google Sheets via image beacon (most reliable CORS-free method)
// ============================================================
function syncTracker(code){
  if(!CFG.syncUrl)return;
  var td=getTD(code),m=getMI(code),c=countF(code);
  var nos=0;for(var k in td.cim)if(td.cim[k]==="NO")nos++;for(var k in td.mont)if(td.mont[k]==="NO")nos++;
  var gl=(td.gps_log||[]),last=gl.length?gl[gl.length-1]:{};
  var payload={
    a:"s",t:code,tp:m?.type||"",pv:m?.pv||"",
    mx:m?.mx||"",my:m?.my||"",te:CFG.tecnico||"",
    cp:c.cimT>0?Math.round(c.cimF/c.cimT*100):0,
    mp:c.montT>0?Math.round(c.montF/c.montT*100):0,
    pp:c.pct,nos:nos,
    ph:Object.values(td.photos||{}).reduce(function(a,arr){return a+(arr||[]).length},0),
    ob:(td.obs||"").substring(0,100),
    gl:last.lat||"",go:last.lon||""
  };
  if(SYNC_T)clearTimeout(SYNC_T);
  SYNC_T=setTimeout(function(){doSync(payload)},3000);
}

function doSync(payload){
  var encoded=encodeURIComponent(JSON.stringify(payload));
  var url=CFG.syncUrl+"?d="+encoded;
  var s=document.createElement("script");
  s.src=url;
  s.onload=function(){showSync("ok");document.head.removeChild(s)};
  s.onerror=function(){showSync("ok");try{document.head.removeChild(s)}catch(e){}};
  document.head.appendChild(s);
}

function showSync(status){
  SYNC_OK=status;
  document.querySelectorAll('.sync-st').forEach(el=>{
    if(status==='ok')el.innerHTML='<span class="sync-dot" style="color:var(--ok)">‚úÖ Sync</span>';
    else if(status==='sent')el.innerHTML='<span class="sync-dot" style="color:var(--ac)">‚òÅÔ∏è Enviado</span>';
    else if(status==='err')el.innerHTML='<span class="sync-dot" style="color:var(--no)">‚ö†Ô∏è Error</span>';
    else el.innerHTML=CFG.syncUrl?'<span class="sync-dot">‚òÅÔ∏è</span>':'';
  });
  if(status==='ok'||status==='sent')setTimeout(()=>{SYNC_OK=null;showSync('')},4000);
}

function syncAll(){Object.keys(APP.trackers).forEach(function(c){syncTracker(c)})}


// HELPERS
function getMI(c){return MASTER_DATA[c]||null}
function getTD(c){if(!APP.trackers[c])APP.trackers[c]={cim:{},mont:{},photos:{},obs:'',gps_log:[],created:new Date().toISOString()};return APP.trackers[c]}

function initDef(code){
  const td=getTD(code),m=getMI(code);if(!m)return;
  const cfg=PCFG[m.type],filas=cfg.conducida?['motor','conducida']:['motor'];
  filas.forEach(f=>{
    const pils=cfg[f],px=f==='motor'?'fm':'fc';
    pils.forEach((_,i)=>{
      [...MED,...COMP].forEach(field=>{
        const key=px+'_'+i+'_'+field.id;
        if(td.cim[key]==null&&field.def!=null)td.cim[key]=field.def;
      });
    });
  });
  sv();
}

function countF(code){
  const m=getMI(code);if(!m)return{cimF:0,cimT:0,montF:0,montT:0,pct:0};
  const cfg=PCFG[m.type],filas=cfg.conducida?['motor','conducida']:['motor'];
  let cimT=0,cimF=0;const td=getTD(code);
  filas.forEach(f=>{const pils=cfg[f];cimT+=pils.length*(MED.length+COMP.length);
    pils.forEach((_,i)=>{const px=f==='motor'?'fm':'fc';
      [...MED,...COMP].forEach(field=>{if(td.cim[px+'_'+i+'_'+field.id]!=null)cimF++});
    });
  });
  const montT=MONT.reduce((a,s)=>a+s.items.length,0);
  const montF=Object.keys(td.mont).filter(k=>td.mont[k]!=null).length;
  return{cimF,cimT,montF,montT,pct:(cimT+montT)>0?Math.round((cimF+montF)/(cimT+montT)*100):0};
}

// PHOTOS
let photoCB=null;
document.getElementById('cam').onchange=async function(e){
  const files=Array.from(e.target.files||[]);
  const photos=await Promise.all(files.map(f=>new Promise(res=>{
    const r=new FileReader();r.onload=ev=>{
      const img=new Image();img.onload=()=>{
        const cv=document.createElement('canvas');const MX=1200;
        let w=img.width,h=img.height;
        if(w>MX||h>MX){if(w>h){h=(h/w)*MX;w=MX}else{w=(w/h)*MX;h=MX}}
        cv.width=w;cv.height=h;cv.getContext('2d').drawImage(img,0,0,w,h);
        res({data:cv.toDataURL('image/jpeg',0.7),ts:new Date().toISOString(),gps:gpsNow()});
      };img.src=ev.target.result;
    };r.readAsDataURL(f);
  })));
  if(photoCB)photoCB(photos);this.value='';
};

// EXPORT
function exportTr(code){
  const td=getTD(code),m=getMI(code),cfg=PCFG[m.type],wb=XLSX.utils.book_new();
  const rows=[['CHECK LIST CIMENTACIONES - '+code],['Tipo:',m.type,'','Coord X:',m.mx,'Coord Y:',m.my],['Fecha:',new Date().toLocaleDateString('es-ES')],[]];
  (cfg.conducida?['motor','conducida']:['motor']).forEach(f=>{
    const pils=cfg[f],px=f==='motor'?'fm':'fc';
    rows.push([f==='motor'?'PILARES FILA MOTOR':'PILARES FILA CONDUCIDA']);
    rows.push(['MEDICIONES','Unidad',...pils]);
    MED.forEach(med=>{const r=[med.label,med.unit||'Si/No'];pils.forEach((_,i)=>r.push(td.cim[px+'_'+i+'_'+med.id]??''));rows.push(r);
      if(med.isTramo){const sr=['  ‚Üí Distancia acumulada','mm'];pils.forEach((_,i)=>{const s=calcDistSum(td,px,i,m.type);sr.push(s!=null?s:'')});rows.push(sr)}
    });rows.push([]);rows.push(['COMPROBACI√ìN','Tipo',...pils]);
    COMP.forEach(c=>{const r=[c.label,'Si/No/NA'];pils.forEach((_,i)=>r.push(td.cim[px+'_'+i+'_'+c.id]??''));rows.push(r)});rows.push([]);
  });
  if(td.obs)rows.push(['OBSERVACIONES:',td.obs]);
  if(td.gps_log?.length){rows.push([],['GPS LOG'],['Timestamp','Lat','Lon','Prec']);td.gps_log.forEach(g=>rows.push([g.ts,g.lat,g.lon,g.acc]))}
  const s1=XLSX.utils.aoa_to_sheet(rows);s1['!cols']=[{wch:45},{wch:12},...(cfg.motor.map(()=>({wch:10})))];
  XLSX.utils.book_append_sheet(wb,s1,'Cimentaciones');
  const mr=[['MONTAJE - '+code],['Fecha:',new Date().toLocaleDateString('es-ES')],[]];
  MONT.forEach(sec=>{mr.push([sec.title]);mr.push(['Punto','Resultado']);sec.items.forEach(it=>mr.push([it.label,td.mont[it.id]??'']));mr.push([])});
  const s2=XLSX.utils.aoa_to_sheet(mr);s2['!cols']=[{wch:55},{wch:12}];
  XLSX.utils.book_append_sheet(wb,s2,'Montaje');
  dl(new Blob([XLSX.write(wb,{bookType:'xlsx',type:'array'})]),code+'.xlsx');
}
function exportDash(){
  const wb=XLSX.utils.book_new(),rows=[['RESUMEN ISFV ATALAYA'],[new Date().toLocaleDateString('es-ES')],[],['Tracker','Tipo','PV','%Cim','%Mont','%Total','NOs','Fotos','Estado']];
  Object.keys(APP.trackers).sort().forEach(code=>{const c=countF(code),td=APP.trackers[code],m=getMI(code);
    let nos=0;Object.values(td.cim||{}).forEach(v=>{if(v==='NO')nos++});Object.values(td.mont||{}).forEach(v=>{if(v==='NO')nos++});
    const ph=Object.values(td.photos||{}).reduce((a,arr)=>a+arr.length,0);
    rows.push([code,m?.type||'',m?.pv||'',c.cimT?Math.round(c.cimF/c.cimT*100)+'%':'',c.montT?Math.round(c.montF/c.montT*100)+'%':'',c.pct+'%',nos,ph,c.pct===100?'COMPLETADO':c.pct>0?'EN PROGRESO':'PENDIENTE']);
  });
  const s=XLSX.utils.aoa_to_sheet(rows);XLSX.utils.book_append_sheet(wb,s,'Resumen');
  dl(new Blob([XLSX.write(wb,{bookType:'xlsx',type:'array'})]),'Dashboard_ATALAYA.xlsx');
}
function dl(blob,name){const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();URL.revokeObjectURL(a.href)}

// ============================================================
// RENDER
// ============================================================
function R(){({setup:rSetup,home:rHome,select:rSelect,tracker:rTracker,dashboard:rDash,config:rConfig})[V.screen](document.getElementById('app'));setTimeout(()=>showSync(''),50)}

// SETUP
function rSetup(a){a.innerHTML=`
<div style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px">
  <div style="font-size:48px;margin-bottom:12px">‚òÄÔ∏è</div>
  <h1 style="font-size:20px;margin-bottom:4px">Checklist Solar</h1>
  <p style="color:var(--td);font-size:13px;margin-bottom:28px">ISFV ATALAYA ‚Äî X-ELIO</p>
  <div style="width:100%;max-width:400px">
    <div class="card" style="padding:20px">
      <label style="font-size:12px;color:var(--td);display:block;margin-bottom:6px">Tu nombre</label>
      <input id="sn" type="text" class="inp" placeholder="Ej: Juan Garc√≠a" value="${CFG.tecnico||''}" style="margin-bottom:14px">
      <label style="font-size:12px;color:var(--td);display:block;margin-bottom:6px">URL sincronizaci√≥n</label>
      <input id="su" type="url" class="inp" placeholder="https://script.google.com/macros/s/..." value="${CFG.syncUrl||''}" style="margin-bottom:6px">
      <p style="font-size:11px;color:var(--td);margin-bottom:18px">La URL del Google Apps Script. D√©jala vac√≠a si no la tienes.</p>
      <button onclick="CFG.tecnico=document.getElementById('sn').value.trim();CFG.syncUrl=document.getElementById('su').value.trim();sc();V.screen='home';R()" style="width:100%;height:50px;border-radius:14px;background:var(--ac);color:var(--bg);font-size:16px;font-weight:700">Comenzar</button>
    </div>
  </div>
</div>`}

// HOME
function rHome(a){
  const codes=Object.keys(APP.trackers).sort(),total=codes.length;
  let h='<div class="hdr"><div><h1>‚òÄÔ∏è ISFV ATALAYA</h1><div class="sub">'+(CFG.tecnico||'‚Äî')+' ¬∑ '+total+' trackers</div></div><div class="hdr-r"><span class="sync-st"></span>';
  if(total>0)h+='<button class="btn-icon" onclick="exportDash()" style="background:#217346;color:#fff;font-size:14px">üìä</button>';
  h+='<button class="btn-icon" onclick="V.screen=\'dashboard\';R()" style="background:var(--ac);color:var(--bg)">üìà</button>';
  h+='<button class="btn-icon" onclick="V.screen=\'config\';R()">‚öôÔ∏è</button></div></div>';
  h+='<div class="cnt" style="padding-top:14px"><button onclick="V.screen=\'select\';R()" style="width:100%;height:52px;border-radius:14px;background:var(--ac);color:var(--bg);font-size:15px;font-weight:700;margin-bottom:14px">+ Nueva Inspecci√≥n</button>';
  if(GPS)h+='<div class="gps-i gps-live"><span class="gps-d"></span> GPS: '+GPS.lat.toFixed(6)+', '+GPS.lon.toFixed(6)+' ¬∑ ¬±'+Math.round(GPS.acc)+'m</div>';
  else h+='<div class="gps-i gps-live" style="opacity:.5">üìç Esperando GPS...</div>';
  if(total>0){h+='<div class="stitle" style="margin-top:8px">Recientes</div>';
    codes.slice(-20).reverse().forEach(code=>{const c=countF(code),m=getMI(code),td=APP.trackers[code],ph=Object.values(td.photos||{}).reduce((a,arr)=>a+arr.length,0);
      h+='<button onclick="openTr(\''+code+'\')" style="width:100%;text-align:left;padding:12px;border-radius:12px;background:var(--sf);margin-bottom:6px;border:1px solid '+(c.pct===100?'var(--ok)':'var(--bd)')+'"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><div><span style="font-weight:700;font-size:14px">'+code+'</span><span style="margin-left:6px;font-size:10px;padding:2px 6px;border-radius:5px;background:var(--sf2);color:var(--td)">'+(m?.type||'')+'</span></div><span style="font-size:13px;font-weight:700;color:'+(c.pct===100?'var(--ok)':'var(--ac)')+'">'+c.pct+'%</span></div><div style="display:flex;gap:14px;font-size:10px;color:var(--td)"><span>CIM:'+c.cimF+'/'+c.cimT+'</span><span>MONT:'+c.montF+'/'+c.montT+'</span>'+(ph>0?'<span>üì∑'+ph+'</span>':'')+'</div><div class="prog" style="margin-top:6px"><div class="prog-b '+(c.pct===100?'done':'')+'" style="width:'+c.pct+'%"></div></div></button>';
    });
  }
  h+='</div>';a.innerHTML=h;
}

function openTr(code){V.screen='tracker';V.tr=code;V.tab='cim';V.fila='motor';V.pi=0;V.exp=false;V.ms=null;
  const td=getTD(code);if(!td.gps_log)td.gps_log=[];td.gps_log.push({...gpsNow(),action:'open'});
  initDef(code);sv();R();
}

// SELECT
function rSelect(a){
  const pvs=[...new Set(Object.values(MASTER_DATA).map(d=>d.pv))].sort((x,y)=>x-y);
  a.innerHTML='<div class="hdr"><button class="btn-icon" onclick="V.screen=\'home\';R()" style="font-size:18px">‚Üê</button><div><h1>Seleccionar Tracker</h1></div></div><div class="cnt" style="padding-top:14px"><div class="card" style="padding:16px"><label style="font-size:12px;color:var(--td);display:block;margin-bottom:6px">PV</label><select class="sel" id="sp" style="width:100%;margin-bottom:12px" onchange="updTL()"><option value="">‚Äî Selecciona PV ‚Äî</option>'+pvs.map(p=>'<option value="'+p+'">PV'+String(p).padStart(2,'0')+'</option>').join('')+'</select><label style="font-size:12px;color:var(--td);display:block;margin-bottom:6px">N¬∫ Tracker</label><select class="sel" id="st" style="width:100%;margin-bottom:12px"><option value="">‚Äî Primero selecciona PV ‚Äî</option></select><div id="tp"></div><button id="bs" class="hide" onclick="startInsp()" style="width:100%;height:46px;border-radius:12px;background:var(--ac);color:var(--bg);font-size:15px;font-weight:700;margin-top:10px">Comenzar Inspecci√≥n</button></div></div>';
}
function updTL(){
  const pv=parseInt(document.getElementById('sp').value),sel=document.getElementById('st');
  if(!pv){sel.innerHTML='<option value="">‚Äî Primero selecciona PV ‚Äî</option>';return}
  const trs=Object.entries(MASTER_DATA).filter(([_,d])=>d.pv===pv).sort((a,b)=>a[1].num-b[1].num);
  sel.innerHTML='<option value="">‚Äî Selecciona tracker ‚Äî</option>'+trs.map(([code,d])=>{
    const ins=APP.trackers[code]?' ‚úì '+countF(code).pct+'%':'';
    return'<option value="'+code+'">'+d.num+' ‚Äî '+d.type+' ('+d.n+' sop.)'+ins+'</option>'}).join('');
  sel.onchange=showTP;
}
function showTP(){
  const code=document.getElementById('st').value,div=document.getElementById('tp'),btn=document.getElementById('bs');
  if(!code){div.innerHTML='';btn.classList.add('hide');return}
  const m=getMI(code),cfg=PCFG[m.type];btn.classList.remove('hide');
  div.innerHTML='<div style="padding:10px;border-radius:10px;background:var(--sf2);margin-top:8px"><div style="font-weight:700;margin-bottom:4px">'+code+'</div><div style="font-size:12px;color:var(--td)">Tipo: '+m.type+' ¬∑ '+m.n+' soportes</div><div style="font-size:12px;color:var(--td)">Coord: '+(m.mx?.toFixed(3)||'‚Äî')+', '+(m.my?.toFixed(3)||'‚Äî')+'</div><div style="font-size:12px;color:var(--td)">Motor: '+cfg.motor.join(', ')+'</div>'+(cfg.conducida?'<div style="font-size:12px;color:var(--td)">Conducida: '+cfg.conducida.join(', ')+'</div>':'<div style="font-size:12px;color:var(--na)">Monofila</div>')+'</div>';
}
function startInsp(){const code=document.getElementById('st').value;if(code)openTr(code)}

// TRACKER
function rTracker(a){
  const code=V.tr,td=getTD(code),m=getMI(code),cfg=PCFG[m.type],c=countF(code);
  const ph=Object.values(td.photos||{}).reduce((x,arr)=>x+arr.length,0);
  let h='<div class="hdr"><button class="btn-icon" onclick="V.screen=\'home\';R()" style="font-size:18px">‚Üê</button><div><h1>'+code+'</h1><div class="sub">'+m.type+' ¬∑ '+c.pct+'%</div></div><div class="hdr-r"><span class="sync-st"></span><button class="btn-icon" onclick="V.exp=!V.exp;R()" style="background:var(--ac);color:var(--bg)">üì§</button><div style="min-width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;background:'+(c.pct===100?'var(--ok)':'var(--sf2)')+';color:'+(c.pct===100?'#fff':'var(--ac)')+'">'+c.pct+'%</div></div></div>';
  if(V.exp)h+='<div class="exp"><button class="exp-b" onclick="exportTr(\''+code+'\');V.exp=false;R()" style="background:#217346;color:#fff">üìä Exportar Excel</button></div>';
  h+='<div class="cnt" style="padding-top:6px">';
  h+='<div class="gps-i">üìç Proyecto: <b>'+(m.mx?.toFixed(3)||'‚Äî')+'</b>, <b>'+(m.my?.toFixed(3)||'‚Äî')+'</b></div>';
  h+='<div class="gps-i gps-live">'+(GPS?'<span class="gps-d"></span> GPS: '+GPS.lat.toFixed(6)+', '+GPS.lon.toFixed(6)+' ¬∑ ¬±'+Math.round(GPS.acc)+'m':'üìç Esperando GPS...')+'</div>';
  const cP=c.cimT>0?Math.round(c.cimF/c.cimT*100):0,mP=c.montT>0?Math.round(c.montF/c.montT*100):0;
  h+='<div style="display:flex;gap:6px;margin-bottom:10px">';
  [{id:'cim',l:'Cimentaciones',p:cP,f:c.cimF,t:c.cimT},{id:'mont',l:'Montaje',p:mP,f:c.montF,t:c.montT}].forEach(x=>{
    h+='<button onclick="V.tab=\''+x.id+'\';V.pi=0;R()" style="flex:1;padding:10px;border-radius:10px;border:2px solid '+(V.tab===x.id?'var(--ac)':'var(--bd)')+';background:'+(V.tab===x.id?'var(--sf2)':'transparent')+'"><div style="font-size:12px;font-weight:700;color:'+(V.tab===x.id?'var(--ac)':'var(--td)')+'">'+x.l+'</div><div class="prog" style="margin-top:5px"><div class="prog-b '+(x.p===100?'done':'')+'" style="width:'+x.p+'%"></div></div><div style="font-size:10px;color:var(--td);margin-top:3px">'+x.f+'/'+x.t+'</div></button>';
  });
  h+='</div>';
  h+=V.tab==='cim'?rCim(code,td,m,cfg):rMont(code,td);
  h+='<div style="margin-top:16px"><div class="stitle">Observaciones</div><textarea class="ta" rows="3" placeholder="Observaciones..." oninput="getTD(\''+code+'\').obs=this.value;sv();syncTracker(\''+code+'\')">'+(td.obs||'')+'</textarea></div></div>';
  a.innerHTML=h;
}

// CIMENTACIONES
function rCim(code,td,m,cfg){
  const filas=cfg.conducida?['motor','conducida']:['motor'];
  let h='';
  if(cfg.conducida){h+='<div class="tabs">';filas.forEach(f=>h+='<button class="tab '+(V.fila===f?'on':'')+'" onclick="V.fila=\''+f+'\';V.pi=0;R()">'+(f==='motor'?'Fila Motor':'Fila Conducida')+'</button>');h+='</div>'}
  const pils=cfg[V.fila]||cfg.motor,px=V.fila==='motor'?'fm':'fc',pi=V.pi,mpI=getMPi(m.type);
  h+='<div class="pils">';
  pils.forEach((p,i)=>{let fl=0;[...MED,...COMP].forEach(f=>{if(td.cim[px+'_'+i+'_'+f.id]!=null)fl++});const tt=MED.length+COMP.length;
    h+='<button class="pil '+(fl===tt?'ok':i===pi?'on':'')+'" onclick="V.pi='+i+';R()">'+p+'<div style="font-size:9px;opacity:.6;margin-top:2px">'+fl+'/'+tt+'</div></button>';
  });
  h+='</div>';
  // Photos
  const pk='cim_'+px+'_'+pils[pi],pph=td.photos[pk]||[];
  h+='<div class="card"><div style="font-size:10px;font-weight:700;color:var(--td);margin-bottom:4px">üì∑ '+pils[pi]+'</div><div class="photo-row">';
  pph.forEach((_,i)=>h+='<div class="ph-th"><img src="'+pph[i].data+'"><button class="ph-del" onclick="rmPh(\''+code+'\',\''+pk+'\','+i+')">√ó</button></div>');
  h+='<button class="ph-add" onclick="tkPh(\''+code+'\',\''+pk+'\')"><span style="font-size:18px">üì∑</span><span>Foto</span></button></div></div>';
  
  const isMPpilar=(pi===mpI);
  h+='<div class="stitle">Mediciones ‚Äî '+pils[pi]+'</div>';
  MED.forEach(med=>{
    if(med.isTramo&&isMPpilar)return;
    const key=px+'_'+pi+'_'+med.id,val=td.cim[key];
    let outR=false;if(med.tol&&val!=null)outR=val<med.tol[0]||val>med.tol[1];
    h+='<div class="card"><div style="font-size:13px;margin-bottom:6px">'+med.label+'</div>';
    if(med.type==='number'){
      h+='<div style="display:flex;align-items:center;gap:8px"><input type="number" inputmode="decimal" step="any" class="inp '+(val!=null?'has':'')+' '+(outR?'bad':'')+'" value="'+(val??'')+'" placeholder="‚Äî" onchange="setCV(\''+code+'\',\''+key+'\',this.value)">'+(med.unit?'<span style="font-size:12px;color:var(--td)">'+med.unit+'</span>':'')+'</div>';
      if(outR)h+='<div style="font-size:11px;color:var(--no);margin-top:4px">‚ö† Fuera de tolerancia ('+med.tol[0]+' ‚Äî '+med.tol[1]+')</div>';
      if(med.isTramo&&!isMPpilar){
        const distSum=calcDistSum(td,px,pi,m.type),dc=getDistCfg(m.type),di=dc[pi];
        let sumBad=false;if(distSum!=null&&di)sumBad=distSum<di.tol[0]||distSum>di.tol[1];
        h+='<div class="sum-row" style="'+(sumBad?'color:var(--no);background:#1a0a0a':'')+'"><span style="font-weight:700">Œ£ Acumulada:</span><span style="font-family:monospace;font-size:14px;font-weight:700">'+(distSum!=null?distSum+' mm':'‚Äî')+'</span>'+(di?'<span style="opacity:.6;font-size:10px">Tol: '+di.tol[0]+'‚Äì'+di.tol[1]+'</span>':'')+(sumBad?'<span>‚ö†Ô∏è</span>':'')+'</div>';
      }
    }else{h+=rOkNo(val,"setCV('"+code+"','"+key+"','{V}')")}
    h+='</div>';
  });
  h+='<div class="stitle" style="margin-top:10px">Comprobaci√≥n ‚Äî '+pils[pi]+'</div>';
  COMP.forEach(c=>{const key=px+'_'+pi+'_'+c.id,val=td.cim[key];
    h+='<div class="card card-row"><div class="card-label">'+c.label+'</div>'+rOkNo(val,"setCV('"+code+"','"+key+"','{V}')",true)+'</div>';
  });
  return h;
}

function setCV(code,key,val){const td=getTD(code);
  if(val===''||val==null)td.cim[key]=null;
  else if(['OK','NO','NA','SI','N/A'].includes(val))td.cim[key]=td.cim[key]===val?null:val;
  else td.cim[key]=parseFloat(val);
  sv();syncTracker(code);R();
}

// MONTAJE
function rMont(code,td){
  if(!V.ms)V.ms=MONT[0].id;
  let h='<div class="tabs">';
  MONT.forEach(s=>{const fl=s.items.filter(i=>td.mont[i.id]!=null).length;const lb=s.title.length>16?s.title.substring(0,14)+'‚Ä¶':s.title;
    h+='<button class="tab '+(V.ms===s.id?'on':'')+'" onclick="V.ms=\''+s.id+'\';R()">'+lb+' <span style="opacity:.6">'+fl+'/'+s.items.length+'</span></button>';
  });h+='</div>';
  const sec=MONT.find(s=>s.id===V.ms)||MONT[0];
  const pk='mont_'+sec.id,sph=td.photos[pk]||[];
  h+='<div class="card" style="margin-top:6px"><div style="font-size:10px;font-weight:700;color:var(--td);margin-bottom:4px">üì∑ '+sec.title+'</div><div class="photo-row">';
  sph.forEach((_,i)=>h+='<div class="ph-th"><img src="'+sph[i].data+'"><button class="ph-del" onclick="rmPh(\''+code+'\',\''+pk+'\','+i+')">√ó</button></div>');
  h+='<button class="ph-add" onclick="tkPh(\''+code+'\',\''+pk+'\')"><span style="font-size:18px">üì∑</span><span>Foto</span></button></div></div>';
  sec.items.forEach(it=>{const val=td.mont[it.id];
    h+='<div class="card card-row"><div class="card-label">'+it.label+'</div>'+rOkNo(val,"setMV('"+code+"','"+it.id+"','{V}')",true)+'</div>';
  });return h;
}
function setMV(code,key,val){const td=getTD(code);td.mont[key]=td.mont[key]===val?null:val;sv();syncTracker(code);R()}

// OK/NO/NA
function rOkNo(val,tpl,compact){
  const show=compact?[{v:'SI',l:'SI'},{v:'NO',l:'NO'},{v:'N/A',l:'N/A'}]:[{v:'OK',l:'OK'},{v:'SI',l:'SI'},{v:'NO',l:'NO'},{v:'N/A',l:'N/A'}];
  let h='<div class="okno'+(compact?' cmp':'')+'">';
  show.forEach(o=>{const sc=val===o.v?(o.v==='OK'||o.v==='SI'?'s-ok':o.v==='NO'?'s-no':'s-na'):'';
    h+='<button class="'+sc+'" onclick="'+tpl.replace('{V}',o.v)+'">'+o.l+'</button>';
  });return h+'</div>';
}

// PHOTOS
function tkPh(code,key){photoCB=photos=>{const td=getTD(code);if(!td.photos[key])td.photos[key]=[];td.photos[key].push(...photos);sv();syncTracker(code);R()};document.getElementById('cam').click()}
function rmPh(code,key,i){const td=getTD(code);if(td.photos[key])td.photos[key].splice(i,1);sv();syncTracker(code);R()}

// DASHBOARD
function rDash(a){
  const codes=Object.keys(APP.trackers).sort(),stats=codes.map(c=>({code:c,...countF(c),m:getMI(c)}));
  const done=stats.filter(s=>s.pct===100).length,avg=stats.length?Math.round(stats.reduce((x,s)=>x+s.pct,0)/stats.length):0;
  let nos=0,tph=0;codes.forEach(c=>{const td=APP.trackers[c];Object.values(td.cim||{}).forEach(v=>{if(v==='NO')nos++});Object.values(td.mont||{}).forEach(v=>{if(v==='NO')nos++});tph+=Object.values(td.photos||{}).reduce((x,arr)=>x+arr.length,0)});
  let h='<div class="hdr"><button class="btn-icon" onclick="V.screen=\'home\';R()" style="font-size:18px">‚Üê</button><div><h1>Dashboard</h1></div><div class="hdr-r"><button class="exp-b" onclick="exportDash()" style="height:36px;padding:0 14px;background:#217346;color:#fff;border-radius:10px;font-size:12px;width:auto;margin:0">üìä</button></div></div>';
  h+='<div class="cnt" style="padding-top:14px"><div class="grid2"><div class="sc"><div class="sc-l">Avance</div><div class="sc-v" style="color:var(--ac)">'+avg+'%</div></div><div class="sc"><div class="sc-l">Completados</div><div class="sc-v" style="color:var(--ok)">'+done+'</div></div><div class="sc"><div class="sc-l">NOs</div><div class="sc-v" style="color:'+(nos?'var(--no)':'var(--ok)')+'">'+nos+'</div></div><div class="sc"><div class="sc-l">Fotos</div><div class="sc-v" style="color:var(--ac)">'+tph+'</div></div></div>';
  const byPV={};stats.forEach(s=>{const pv=s.m?.pv||0;if(!byPV[pv])byPV[pv]=[];byPV[pv].push(s)});
  Object.entries(byPV).sort((x,y)=>x[0]-y[0]).forEach(([pv,ps])=>{const dn=ps.filter(s=>s.pct===100).length;
    h+='<div class="card" style="margin-top:10px"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="font-weight:700">PV'+String(pv).padStart(2,'0')+'</span><span style="font-size:10px;padding:3px 6px;border-radius:6px;background:var(--sf2);color:var(--td)">'+dn+'/'+ps.length+'</span></div><div style="display:grid;grid-template-columns:repeat(6,1fr);gap:4px">';
    ps.sort((x,y)=>(x.m?.num||0)-(y.m?.num||0)).forEach(s=>{h+='<div style="aspect-ratio:1;border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;font-weight:700;border:1px solid '+(s.pct===100?'rgba(34,197,94,.3)':s.pct>0?'rgba(245,158,11,.3)':'var(--bd)')+';background:'+(s.pct===100?'rgba(34,197,94,.1)':s.pct>0?'rgba(245,158,11,.1)':'var(--sf2)')+';color:'+(s.pct===100?'var(--ok)':s.pct>0?'var(--ac)':'var(--td)')+'"><div>'+(s.m?.num||'')+'</div><div style="opacity:.6">'+s.pct+'%</div></div>'});
    h+='</div></div>';
  });h+='</div>';a.innerHTML=h;
}

// CONFIG
function rConfig(a){const sz=(JSON.stringify(APP).length/1024).toFixed(1);
  a.innerHTML='<div class="hdr"><button class="btn-icon" onclick="V.screen=\'home\';R()" style="font-size:18px">‚Üê</button><div><h1>Configuraci√≥n</h1></div></div><div class="cnt" style="padding-top:14px"><div class="card" style="padding:14px"><label style="font-size:11px;color:var(--td);display:block;margin-bottom:4px">Nombre</label><input type="text" class="inp" value="'+(CFG.tecnico||'')+'" onchange="CFG.tecnico=this.value.trim();sc()" style="margin-bottom:12px"><label style="font-size:11px;color:var(--td);display:block;margin-bottom:4px">URL sincronizaci√≥n</label><input type="url" class="inp" value="'+(CFG.syncUrl||'')+'" onchange="CFG.syncUrl=this.value.trim();sc()" style="margin-bottom:10px"><button onclick="syncAll();alert(\'Sincronizando \'+ Object.keys(APP.trackers).length+\' trackers...\')" style="width:100%;height:42px;border-radius:10px;background:#217346;color:#fff;font-size:13px;font-weight:700;margin-top:8px">‚òÅÔ∏è Sincronizar TODO</button></div><div class="card" style="padding:14px;margin-top:8px"><div style="font-size:13px;font-weight:700;margin-bottom:6px">Datos: '+Object.keys(APP.trackers).length+' trackers ¬∑ '+sz+' KB</div><button onclick="if(confirm(\'Borrar datos locales?\')){APP={trackers:{}};sv();R()}" style="width:100%;height:40px;border-radius:10px;background:transparent;color:var(--no);font-size:12px;border:1px solid var(--no);margin-top:6px">üóëÔ∏è Borrar datos locales</button></div></div>';
}

// INIT
startGPS();R();
if('serviceWorker' in navigator)window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));
</script>
</body>
</html>
